# Lore VM

The Lore VM executes Poem bytecode generated by the Lore compiler. See the project's [readme](../README.md) for more information.



### Advantages and Disadvantages

The VM replaced a Javascript/Typescript runtime that executed Lore code transpiled to Javascript. This section attempts to outline the advantages of this decision and which caveats come with it.

**Advantages:**

- The core runtime code (such as type equality, subtyping and fit, type construction, and custom collections) is much faster in Nim than Javascript. While the performance of V8 is impressive, Nim manages to e.g. squeeze out 2x to 4x more performance for type equality. This is especially due to the ability to turn off runtime checks (such as bounds checks) for performance-critical code, which Javascript does not provide. Nim being a systems programming language also gives more options for optimizing algorithms by avoiding allocations. Optimizing memory operations and data structures is easier which allows implementing high-performance, custom, immutable lists, whereas in Javascript an array is the only heavily optimized list. The core run-time structures of Lore can be implemented natively using Nim, as opposed to with one layer of indirection with Javascript, as a Lore type would also be a JS object. This translates to better performance, but is also overall cleaner.
  - Because the VM interprets the bytecode, it's inherently slower than the Javascript runtime. However, the slowdown is in the order of 1.5x to 3x depending on the program, which is smaller than the expected 5-10x for bytecode interpreters, because parts of the core runtime code are already faster than their Javascript counterparts. Once we implement JIT compilation (first for dispatch functions, then for bytecode) the VM should pull ahead of the Javascript runtime. (Lore is *not* faster than pure JS, but JIT-compiled Lore running on the VM is very likely faster than Lore transpiled to Javascript.)
- With the Javascript runtime, the Lore compiler directly generated dispatch functions, so any dispatch optimizations had to be carried out by the compiler. With the VM, the burden of optimizing dispatch is shifted to the VM, which makes the compiler considerably leaner.
- Nim provides native threading, while Javascript is single-threaded. Implementing parallelism for Lore in Javascript would be hard or impossible. 
- Nim allows implementing a native C FFI between the Lore VM and other C-compatible code. This will make it relatively easy to integrate Lore into existing software, games (e.g. a game engine such as Godot), and with other compiled languages.

**Caveats:**

- As noted above, the VM is currently slower than the Javascript runtime by 2 or 3 times. This will improve as the VM develops.
- The VM is not as portable as Javascript code, so it is not possible or easy to run Lore code in the browser. However, it might be feasible to translate poem bytecode to targets like WebAssembly.
- The VM is more difficult to develop than the Javascript runtime and more complex, requiring additional development time.
